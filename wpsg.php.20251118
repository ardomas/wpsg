<?php
/**
 * Plugin Name: WPSG — Wonder Pieces Simple Gear
 * Plugin URI:  https://ardomas.com/
 * Description: Modular utility plugin containing small tools for WordPress. Developed by Sam & Gepeto.
 * Version:     0.1.0
 * Author:      Samodra & Gepeto
 * Text Domain: wpsg
 * Domain Path: /languages
 */

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

require_once plugin_dir_path(__FILE__) . 'admin/admin-frontend.php';

// Define plugin constants.
define( 'WPSG_VERSION', '0.1.0' );
define( 'WPSG_DIR', plugin_dir_path( __FILE__ ) );
define( 'WPSG_URL', plugin_dir_url( __FILE__ ) );

// Load the plugin loader.
// Load Locales Tool

$plugin_loaders = [
    WPSG_DIR . 'includes/tools/locales/locales-loader.php',
    WPSG_DIR . 'includes/loader.php'
];

foreach( $plugin_loaders as $loader ){
    if ( file_exists( $loader ) ) {
        require_once $loader;
    }
}

// new WPSG_Admin_Frontend();

// Tambahkan menu ke WP Admin  

add_action('admin_menu', function() {
    add_menu_page(
        'WPSG Admin',
        'WPSG Admin',
        'manage_options',
        'wpsg-admin',
        function() {
            wp_redirect(site_url('/wpsg-admin'));
            exit;
        },
        'dashicons-admin-generic',
        2
    );
});

add_action('admin_init', function() {
    if (isset($_GET['page']) && $_GET['page'] === 'wpsg-admin') {
        wp_redirect(site_url('wpsg-admin'));
        exit;
    }
});

add_action('init', function() {
    add_rewrite_rule('^wpsg-admin/?$', 'index.php?wpsg_subpage=dashboard', 'top');
    add_rewrite_rule('^wpsg-admin/([^/]+)/?$', 'index.php?wpsg_subpage=$matches[1]', 'top');
});

add_filter('query_vars', function($vars){
    $vars[] = 'wpsg_subpage';
    return $vars;
});

// Register custom query var
add_filter('query_vars', function($vars) {
    $vars[] = 'wpsg_admin';
    $vars[] = 'pwsg_page';
    return $vars;
});

add_action('template_redirect', function() {

    if (get_query_var('wpsg_admin') != 1) {
        return;
    }

    // Ambil page
    $page = get_query_var('wpsg_page');
    if (empty($page)) {
        $page = 'dashboard'; // default
    }

    // Pastikan hanya karakter aman
    $page = sanitize_key($page);

    // Tentukan view file
    $view_file = WPSG_DIR . "admin/views/{$page}.php";

    // Jika halaman tidak ditemukan
    if (!file_exists($view_file)) {
        $view_file = WPSG_DIR . "admin/views/404.php";
    }

    // Buat variabel yang bisa dipakai layout
    $GLOBALS['wpsg_current_page'] = $page;
    $GLOBALS['wpsg_view_file'] = $view_file;

    if (get_query_var('wpsg_admin') == 1) {

        // Load WPSG admin layout
        include WPSG_DIR . 'admin/views/layout.php';

        exit;
    }

});

// ---------------------------
// 3️⃣ Template redirect untuk load page
// ---------------------------
add_action('template_redirect', function() {

    $subpage = get_query_var('page');
    if (!$subpage) return; // bukan route WPSG Admin

    // Default ke dashboard
    $subpage = sanitize_key($subpage);
    if (empty($subpage)) $subpage = 'dashboard';

    $GLOBALS['wpsg_current_page'] = $subpage;

    // Tentukan view file
    switch($subpage) {
        case 'dashboard':
            $GLOBALS['wpsg_view_file'] = WPSG_DIR . 'admin/views/dashboard.php';
            break;

        case 'profile':
            $GLOBALS['wpsg_view_file'] = WPSG_DIR . 'admin/views/profile.php';
            break;

        default:
            $GLOBALS['wpsg_view_file'] = WPSG_DIR . 'admin/views/404.php';
            break;
    }

    // Load layout
    include WPSG_DIR . 'admin/views/layout.php';
    exit;
});

// di wpsg.php — somewhere early (setelah mendefinisikan WPSG_DIR)
add_action('wp_enqueue_scripts', function() {
    // Only load on wpsg-admin front route
    if ( get_query_var('wpsg_admin') != 1 ) {
        return;
    }

    // Dashicons (icon set WP)
    wp_enqueue_style('dashicons');

    // Core admin styles (official WP files)
    wp_enqueue_style('wpsg-admin-wp-admin', admin_url('css/wp-admin.css'), [], null);
    wp_enqueue_style('wpsg-admin-admin-menu', admin_url('css/admin-menu.css'), [], null);
    wp_enqueue_style('wpsg-admin-common', admin_url('css/common.css'), [], null);
    wp_enqueue_style('wpsg-admin-forms', admin_url('css/forms.css'), [], null);

    // Optionally enqueue admin JS if needed (some interactions rely on it)
    wp_enqueue_script('wpsg-admin-common-js', admin_url('js/common.js'), ['jquery'], null, true);
    wp_enqueue_script('wpsg-admin-list-tables', admin_url('js/list-tables.js'), ['jquery'], null, true);

    // Ensure WP Admin color variables available by including admin color scheme inline vars (optional)
    // This line will print admin color scheme CSS variables into head via admin_print_styles action,
    // but using admin CSS files above usually already includes required rules.
});
